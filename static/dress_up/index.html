<!doctype HTML>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Create new kanojo</title>
    <script type='text/javascript'>
//<![CDATA[
var canvas = document.createElement("canvas"),
	ctx = canvas.getContext("2d");
var originalPixels = null,
	currentPixels = null;


var sprites_info = {"body":[{"x":50,"y":247,"id":1,"img":"body_001.png","color":"c_skin"}],"hair":[{"x":83,"y":3,"id":1,"img":"hair_001.png","color":"c_hair"},{"x":103,"y":3,"id":2,"img":"hair_002.png","color":"c_hair"},{"x":109,"y":0,"id":3,"img":"hair_003.png","color":"c_hair"},{"x":77,"y":4,"id":4,"img":"hair_004.png","color":"c_hair"},{"x":82,"y":7,"id":5,"img":"hair_005.png","color":"c_hair"},{"x":74,"y":0,"id":6,"img":"hair_006.png","color":"c_hair"},{"x":72,"y":6,"id":7,"img":"hair_007.png","color":"c_hair"},{"x":86,"y":8,"id":8,"img":"hair_008.png","color":"c_hair"},{"x":77,"y":7,"id":9,"img":"hair_009.png","color":"c_hair"},{"x":51,"y":6,"id":10,"img":"hair_010.png","color":"c_hair"},{"x":94,"y":8,"id":11,"img":"hair_011.png","color":"c_hair"},{"x":93,"y":8,"id":12,"img":"hair_012.png","color":"c_hair"},{"x":53,"y":8,"id":13,"img":"hair_013.png","color":"c_hair"},{"x":107,"y":8,"id":14,"img":"hair_014.png","color":"c_hair"},{"x":92,"y":6,"id":15,"img":"hair_015.png","color":"c_hair"},{"x":80,"y":5,"id":16,"img":"hair_016.png","color":"c_hair"},{"x":86,"y":8,"id":17,"img":"hair_017.png","color":"c_hair"},{"x":51,"y":3,"id":18,"img":"hair_018.png","color":"c_hair"},{"x":65,"y":4,"id":19,"img":"hair_019.png","color":"c_hair"},{"x":69,"y":0,"id":20,"img":"hair_020.png","color":"c_hair"},{"x":80,"y":0,"id":21,"img":"hair_021.png","color":"c_hair"},{"x":91,"y":4,"id":22,"img":"hair_022.png","color":"c_hair"},{"x":96,"y":6,"id":23,"img":"hair_023.png","color":"c_hair"},{"x":93,"y":6,"id":24,"img":"hair_024.png","color":"c_hair"},{"x":43,"y":3,"id":25,"img":"hair_025.png","color":"c_hair"},{"x":53,"y":4,"id":26,"img":"hair_026.png","color":"c_hair"}],"face":[{"x":124,"y":75,"id":1,"img":"face_001.png","color":"c_skin"},{"x":124,"y":73,"id":2,"img":"face_002.png","color":"c_skin"},{"x":123,"y":76,"id":3,"img":"face_003.png","color":"c_skin"},{"x":125,"y":73,"id":4,"img":"face_004.png","color":"c_skin"},{"x":124,"y":65,"id":5,"img":"face_005.png","color":"c_skin"},{"x":127,"y":72,"id":6,"img":"face_006.png","color":"c_skin"}],"fringe":[[{"x":123,"y":71,"id":1,"img":"fringe_001_tex_0.png","color":"c_skin"},{"x":117,"y":17,"id":1,"img":"fringe_001_tex_1.png","color":"c_hair"}],[{"x":122,"y":81,"id":2,"img":"fringe_002_tex_0.png","color":"c_skin"},{"x":113,"y":27,"id":2,"img":"fringe_002_tex_1.png","color":"c_hair"}],[{"x":123,"y":56,"id":3,"img":"fringe_003_tex_0.png","color":"c_skin"},{"x":114,"y":32,"id":3,"img":"fringe_003_tex_1.png","color":"c_hair"}],[{"x":121,"y":88,"id":4,"img":"fringe_004_tex_0.png","color":"c_skin"},{"x":117,"y":20,"id":4,"img":"fringe_004_tex_1.png","color":"c_hair"}],[{"x":132,"y":79,"id":5,"img":"fringe_005_tex_0.png","color":"c_skin"},{"x":116,"y":33,"id":5,"img":"fringe_005_tex_1.png","color":"c_hair"}],[{"x":127,"y":93,"id":6,"img":"fringe_006_tex_0.png","color":"c_skin"},{"x":117,"y":51,"id":6,"img":"fringe_006_tex_1.png","color":"c_hair"}],[{"x":135,"y":94,"id":7,"img":"fringe_007_tex_0.png","color":"c_skin"},{"x":114,"y":28,"id":7,"img":"fringe_007_tex_1.png","color":"c_hair"}],[{"x":130,"y":75,"id":8,"img":"fringe_008_tex_0.png","color":"c_skin"},{"x":106,"y":28,"id":8,"img":"fringe_008_tex_1.png","color":"c_hair"}],{"x":100,"y":28,"id":9,"img":"fringe_009.png","color":"c_hair"},[{"x":121,"y":67,"id":10,"img":"fringe_010_tex_0.png","color":"c_skin"},{"x":107,"y":23,"id":10,"img":"fringe_010_tex_1.png","color":"c_hair"}],[{"x":134,"y":78,"id":11,"img":"fringe_011_tex_0.png","color":"c_skin"},{"x":103,"y":21,"id":11,"img":"fringe_011_tex_1.png","color":"c_hair"}],[{"x":123,"y":87,"id":12,"img":"fringe_012_tex_0.png","color":"c_skin"},{"x":112,"y":32,"id":12,"img":"fringe_012_tex_1.png","color":"c_hair"}],{"x":111,"y":21,"id":13,"img":"fringe_013.png","color":"c_hair"},[{"x":132,"y":65,"id":14,"img":"fringe_014_tex_0.png","color":"c_skin"},{"x":113,"y":29,"id":14,"img":"fringe_014_tex_1.png","color":"c_hair"}],{"x":101,"y":24,"id":15,"img":"fringe_015.png","color":"c_hair"},{"x":101,"y":33,"id":16,"img":"fringe_016.png","color":"c_hair"},[{"x":128,"y":88,"id":17,"img":"fringe_017_tex_0.png","color":"c_skin"},{"x":121,"y":31,"id":17,"img":"fringe_017_tex_1.png","color":"c_hair"}],[{"x":130,"y":70,"id":18,"img":"fringe_018_tex_0.png","color":"c_skin"},{"x":113,"y":20,"id":18,"img":"fringe_018_tex_1.png","color":"c_hair"}],[{"x":131,"y":77,"id":19,"img":"fringe_019_tex_0.png","color":"c_skin"},{"x":111,"y":36,"id":19,"img":"fringe_019_tex_1.png","color":"c_hair"}],[{"x":123,"y":68,"id":20,"img":"fringe_020_tex_0.png","color":"c_skin"},{"x":112,"y":45,"id":20,"img":"fringe_020_tex_1.png","color":"c_hair"}],{"x":118,"y":23,"id":21,"img":"fringe_021.png","color":"c_hair"},[{"x":130,"y":80,"id":22,"img":"fringe_022_tex_0.png","color":"c_skin"},{"x":109,"y":31,"id":22,"img":"fringe_022_tex_1.png","color":"c_hair"}]],"mouth":[{"x":202,"y":244,"id":1,"img":"mouth_001.png","color":"c_skin"},{"x":190,"y":238,"id":2,"img":"mouth_002.png","color":"c_skin"},{"x":200,"y":242,"id":3,"img":"mouth_003.png","color":"c_skin"},{"x":209,"y":247,"id":4,"img":"mouth_004.png","color":"c_skin"},{"x":204,"y":245,"id":5,"img":"mouth_005.png","color":"c_skin"},{"x":203,"y":247,"id":6,"img":"mouth_006.png","color":"c_skin"},{"x":201,"y":247,"id":7,"img":"mouth_007.png","color":"c_skin"},{"x":202,"y":247,"id":8,"img":"mouth_008.png","color":"c_skin"},{"x":201,"y":242,"id":9,"img":"mouth_009.png","color":"c_skin"},{"x":206,"y":245,"id":10,"img":"mouth_010.png","color":"c_skin"},{"x":199,"y":245,"id":11,"img":"mouth_011.png","color":"c_skin"},{"x":202,"y":246,"id":12,"img":"mouth_012.png","color":"c_skin"}],"eye":[[{"x":150,"y":165,"id":101,"img":"eye_101_tex_0.png"},{"x":158,"y":168,"id":101,"img":"eye_101_tex_1.png","color":"c_eye"},{"x":146,"y":157,"id":101,"img":"eye_101_tex_2.png"}],[{"x":150,"y":170,"id":102,"img":"eye_102_tex_0.png"},{"x":161,"y":173,"id":102,"img":"eye_102_tex_1.png","color":"c_eye"},{"x":147,"y":163,"id":102,"img":"eye_102_tex_2.png"}],[{"x":152,"y":163,"id":103,"img":"eye_103_tex_0.png"},{"x":158,"y":166,"id":103,"img":"eye_103_tex_1.png","color":"c_eye"},{"x":144,"y":163,"id":103,"img":"eye_103_tex_2.png"}],[{"x":152,"y":165,"id":104,"img":"eye_104_tex_0.png"},{"x":157,"y":167,"id":104,"img":"eye_104_tex_1.png","color":"c_eye"},{"x":149,"y":159,"id":104,"img":"eye_104_tex_2.png"}],[{"x":155,"y":166,"id":105,"img":"eye_105_tex_0.png"},{"x":158,"y":168,"id":105,"img":"eye_105_tex_1.png","color":"c_eye"},{"x":150,"y":158,"id":105,"img":"eye_105_tex_2.png"}],[{"x":154,"y":169,"id":106,"img":"eye_106_tex_0.png"},{"x":159,"y":169,"id":106,"img":"eye_106_tex_1.png","color":"c_eye"},{"x":147,"y":161,"id":106,"img":"eye_106_tex_2.png"}],[{"x":156,"y":169,"id":107,"img":"eye_107_tex_0.png"},{"x":159,"y":168,"id":107,"img":"eye_107_tex_1.png","color":"c_eye"},{"x":149,"y":160,"id":107,"img":"eye_107_tex_2.png"}],[{"x":157,"y":170,"id":108,"img":"eye_108_tex_0.png"},{"x":164,"y":173,"id":108,"img":"eye_108_tex_1.png","color":"c_eye"},{"x":153,"y":165,"id":108,"img":"eye_108_tex_2.png"}],[{"x":156,"y":168,"id":109,"img":"eye_109_tex_0.png"},{"x":163,"y":169,"id":109,"img":"eye_109_tex_1.png","color":"c_eye"},{"x":150,"y":160,"id":109,"img":"eye_109_tex_2.png"}],[{"x":155,"y":173,"id":110,"img":"eye_110_tex_0.png"},{"x":163,"y":174,"id":110,"img":"eye_110_tex_1.png","color":"c_eye"},{"x":150,"y":166,"id":110,"img":"eye_110_tex_2.png"}],[{"x":156,"y":173,"id":111,"img":"eye_111_tex_0.png"},{"x":157,"y":170,"id":111,"img":"eye_111_tex_1.png","color":"c_eye"},{"x":155,"y":161,"id":111,"img":"eye_111_tex_2.png"}],[{"x":153,"y":178,"id":112,"img":"eye_112_tex_0.png"},{"x":160,"y":174,"id":112,"img":"eye_112_tex_1.png","color":"c_eye"},{"x":142,"y":165,"id":112,"img":"eye_112_tex_2.png"}],[{"x":153,"y":177,"id":113,"img":"eye_113_tex_0.png"},{"x":163,"y":176,"id":113,"img":"eye_113_tex_1.png","color":"c_eye"},{"x":147,"y":169,"id":113,"img":"eye_113_tex_2.png"}],[{"x":158,"y":169,"id":114,"img":"eye_114_tex_0.png"},{"x":163,"y":171,"id":114,"img":"eye_114_tex_1.png","color":"c_eye"},{"x":152,"y":162,"id":114,"img":"eye_114_tex_2.png"}],[{"x":152,"y":165,"id":115,"img":"eye_115_tex_0.png"},{"x":164,"y":167,"id":115,"img":"eye_115_tex_1.png","color":"c_eye"},{"x":150,"y":163,"id":115,"img":"eye_115_tex_2.png"}]],"nose":[{"x":214,"y":235,"id":1,"img":"nose_001.png"},{"x":211,"y":235,"id":2,"img":"nose_002.png"},{"x":209,"y":234,"id":3,"img":"nose_003.png"},{"x":211,"y":231,"id":4,"img":"nose_004.png"},{"x":211,"y":235,"id":5,"img":"nose_005.png"},{"x":207,"y":236,"id":6,"img":"nose_006.png"}],"brow":[{"x":135,"y":148,"id":1,"img":"brow_001.png","color":"c_hair"},{"x":136,"y":144,"id":2,"img":"brow_002.png","color":"c_hair"},{"x":159,"y":143,"id":3,"img":"brow_003.png","color":"c_hair"},{"x":140,"y":142,"id":4,"img":"brow_004.png","color":"c_hair"},{"x":146,"y":144,"id":5,"img":"brow_005.png","color":"c_hair"},{"x":140,"y":144,"id":6,"img":"brow_006.png","color":"c_hair"},{"x":139,"y":145,"id":7,"img":"brow_007.png"},{"x":163,"y":147,"id":8,"img":"brow_008.png"},{"x":149,"y":146,"id":9,"img":"brow_009.png"},{"x":168,"y":147,"id":10,"img":"brow_010.png","color":"c_hair"},{"x":138,"y":146,"id":11,"img":"brow_011.png","color":"c_hair"},{"x":135,"y":144,"id":12,"img":"brow_012.png","color":"c_hair"}],"ear":[{"x":112,"y":160,"id":1,"img":"ear_001.png","color":"c_skin"},{"x":102,"y":157,"id":2,"img":"ear_002.png","color":"c_skin"}],"spot":[{"id":1},{"x":270,"y":211,"id":2,"img":"spot_002.png"},{"x":158,"y":206,"id":3,"img":"spot_003.png"},{"x":157,"y":216,"id":4,"img":"spot_002.png"},{"x":247,"y":255,"id":5,"img":"spot_002.png"},{"x":198,"y":262,"id":6,"img":"spot_002.png"},{"x":60,"y":204,"id":7,"img":"spot_007.png"}],"glasses":[{"id":1},{"x":142,"y":165,"id":2,"img":"glasses_002.png"},{"x":135,"y":151,"id":3,"img":"glasses_003.png"},{"x":137,"y":171,"id":4,"img":"glasses_004.png"},{"x":129,"y":166,"id":5,"img":"glasses_005.png"}],"accessory":[{"id":1},{"x":209,"y":-30,"id":2,"img":"accessory_002.png","color":"c_hair"},{"x":272,"y":26,"id":3,"img":"accessory_003.png"},{"x":125,"y":25,"id":4,"img":"accessory_004.png"},{"x":94,"y":18,"id":5,"img":"accessory_005.png","color":"c_hair"},{"x":111,"y":18,"id":6,"img":"accessory_006.png"}],"clothes":[[{"x":78,"y":400,"id":1,"img":"clothes_001_tex_0.png","color":"c_skin"},{"x":56,"y":303,"id":1,"img":"clothes_001_tex_1.png","color":"c_clothes"}],[{"x":74,"y":463,"id":2,"img":"clothes_002_tex_0.png","color":"c_skin"},{"x":42,"y":278,"id":2,"img":"clothes_002_tex_1.png"}],[{"x":127,"y":394,"id":3,"img":"clothes_003_tex_0.png","color":"c_skin"},{"x":120,"y":302,"id":3,"img":"clothes_003_tex_1.png","color":"c_clothes"}],{"x":52,"y":270,"id":4,"img":"clothes_004.png","color":"c_clothes"},{"x":34,"y":295,"id":5,"img":"clothes_005.png"},{"x":34,"y":-53,"id":6,"img":"clothes_006.png"},{"x":39,"y":268,"id":7,"img":"clothes_007.png"},{"x":46,"y":264,"id":8,"img":"clothes_008.png"},{"x":41,"y":271,"id":9,"img":"clothes_009.png"},{"x":44,"y":275,"id":10,"img":"clothes_010.png"},[{"x":144,"y":300,"id":11,"img":"clothes_011_tex_0.png","color":"c_skin"},{"x":24,"y":295,"id":11,"img":"clothes_011_tex_1.png"}],{"x":38,"y":272,"id":12,"img":"clothes_012.png"},[{"x":73,"y":442,"id":13,"img":"clothes_013_tex_0.png","color":"c_skin"},{"x":55,"y":298,"id":13,"img":"clothes_013_tex_1.png"}],{"x":122,"y":303,"id":14,"img":"clothes_014.png"},{"x":120,"y":294,"id":15,"img":"clothes_015.png"},{"x":22,"y":278,"id":16,"img":"clothes_016.png"},{"x":83,"y":296,"id":17,"img":"clothes_017.png"},[{"x":137,"y":399,"id":18,"img":"clothes_018_tex_0.png","color":"c_skin"},{"x":37,"y":274,"id":18,"img":"clothes_018_tex_1.png"}],[{"x":70,"y":309,"id":19,"img":"clothes_019_tex_0.png","color":"c_skin"},{"x":40,"y":306,"id":19,"img":"clothes_019_tex_1.png"}],[{"x":159,"y":283,"id":20,"img":"clothes_020_tex_0.png","color":"c_skin"},{"x":45,"y":264,"id":20,"img":"clothes_020_tex_1.png"}],[{"x":66,"y":511,"id":21,"img":"clothes_021_tex_0.png","color":"c_skin"},{"x":42,"y":267,"id":21,"img":"clothes_021_tex_1.png"}],{"x":33,"y":260,"id":22,"img":"clothes_022.png"},{"x":43,"y":267,"id":23,"img":"clothes_023.png"},[{"x":80,"y":398,"id":24,"img":"clothes_024_tex_0.png","color":"c_skin"},{"x":52,"y":261,"id":24,"img":"clothes_024_tex_1.png"}],{"x":58,"y":276,"id":25,"img":"clothes_025.png"},{"x":43,"y":275,"id":26,"img":"clothes_026.png"},[{"x":74,"y":288,"id":27,"img":"clothes_027_tex_0.png","color":"c_skin"},{"x":65,"y":13,"id":27,"img":"clothes_027_tex_1.png"}],[{"x":139,"y":397,"id":28,"img":"clothes_028_tex_0.png","color":"c_skin"},{"x":122,"y":417,"id":28,"img":"clothes_028_tex_1.png"}],{"x":43,"y":296,"id":29,"img":"clothes_029.png"},[{"x":139,"y":397,"id":30,"img":"clothes_030_tex_0.png","color":"c_skin"},{"x":41,"y":300,"id":30,"img":"clothes_030_tex_1.png"}],[{"x":131,"y":305,"id":31,"img":"clothes_031_tex_0.png","color":"c_skin"},{"x":49,"y":298,"id":31,"img":"clothes_031_tex_1.png"}],{"x":38,"y":302,"id":32,"img":"clothes_032.png"},[{"x":155,"y":310,"id":33,"img":"clothes_033_tex_0.png","color":"c_skin"},{"x":49,"y":300,"id":33,"img":"clothes_033_tex_1.png"}],{"x":44,"y":259,"id":34,"img":"clothes_034.png"},{"x":44,"y":283,"id":35,"img":"clothes_035.png"},{"x":48,"y":273,"id":36,"img":"clothes_036.png"},[{"x":73,"y":308,"id":37,"img":"clothes_037_tex_0.png","color":"c_skin"},{"x":73,"y":302,"id":37,"img":"clothes_037_tex_1.png"}],{"x":41,"y":301,"id":38,"img":"clothes_038.png"},[{"x":73,"y":455,"id":39,"img":"clothes_039_tex_0.png","color":"c_skin"},{"x":55,"y":280,"id":39,"img":"clothes_039_tex_1.png"}],[{"x":132,"y":304,"id":40,"img":"clothes_040_tex_0.png","color":"c_skin"},{"x":61,"y":18,"id":40,"img":"clothes_040_tex_1.png"}],[{"x":78,"y":301,"id":41,"img":"clothes_041_tex_0.png","color":"c_skin"},{"x":46,"y":280,"id":41,"img":"clothes_041_tex_1.png"}],[{"x":139,"y":305,"id":42,"img":"clothes_042_tex_0.png","color":"c_skin"},{"x":26,"y":301,"id":42,"img":"clothes_042_tex_1.png"}],{"x":53,"y":261,"id":43,"img":"clothes_043.png"},{"x":46,"y":272,"id":44,"img":"clothes_044.png"},{"x":30,"y":243,"id":45,"img":"clothes_045.png"},[{"x":186,"y":301,"id":46,"img":"clothes_046_tex_0.png","color":"c_skin"},{"x":52,"y":258,"id":46,"img":"clothes_046_tex_1.png"}],{"x":45,"y":-18,"id":47,"img":"clothes_047.png"},{"x":65,"y":300,"id":48,"img":"clothes_048.png"},{"x":66,"y":300,"id":49,"img":"clothes_049.png"},[{"x":209,"y":397,"id":51,"img":"clothes_051_tex_0.png","color":"c_skin"},{"x":75,"y":320,"id":51,"img":"clothes_051_tex_1.png"}],{"x":102,"y":302,"id":52,"img":"clothes_052.png"},[{"x":73,"y":300,"id":53,"img":"clothes_053_tex_0.png","color":"c_skin"},{"x":60,"y":300,"id":53,"img":"clothes_053_tex_1.png"}],[{"x":138,"y":310,"id":54,"img":"clothes_054_tex_0.png","color":"c_skin"},{"x":103,"y":302,"id":54,"img":"clothes_054_tex_1.png"}],[{"x":138,"y":392,"id":55,"img":"clothes_055_tex_0.png","color":"c_skin"},{"x":125,"y":387,"id":55,"img":"clothes_055_tex_1.png"}],[{"x":141,"y":380,"id":56,"img":"clothes_056_tex_0.png","color":"c_skin"},{"x":129,"y":283,"id":56,"img":"clothes_056_tex_1.png"}],[{"x":130,"y":406,"id":57,"img":"clothes_057_tex_0.png","color":"c_skin"},{"x":128,"y":401,"id":57,"img":"clothes_057_tex_1.png"}],[{"x":125,"y":297,"id":58,"img":"clothes_058_tex_0.png","color":"c_skin"},{"x":133,"y":294,"id":58,"img":"clothes_058_tex_1.png"}],[{"x":218,"y":366,"id":59,"img":"clothes_059_tex_0.png","color":"c_skin"},{"x":44,"y":285,"id":59,"img":"clothes_059_tex_1.png"}],{"x":40,"y":357,"id":60,"img":"clothes_060.png"},[{"x":140,"y":304,"id":61,"img":"clothes_061_tex_0.png","color":"c_skin"},{"x":101,"y":302,"id":61,"img":"clothes_061_tex_1.png"}],{"x":111,"y":279,"id":62,"img":"clothes_062.png"},[{"x":75,"y":434,"id":63,"img":"clothes_063_tex_0.png","color":"c_skin"},{"x":57,"y":281,"id":63,"img":"clothes_063_tex_1.png"}],{"x":55,"y":281,"id":64,"img":"clothes_064.png"},{"x":35,"y":273,"id":65,"img":"clothes_065.png"},{"x":38,"y":281,"id":66,"img":"clothes_066.png"},{"x":44,"y":271,"id":67,"img":"clothes_067.png"},{"x":48,"y":277,"id":68,"img":"clothes_068.png"},{"x":47,"y":265,"id":69,"img":"clothes_069.png"},{"x":53,"y":294,"id":70,"img":"clothes_070.png"},[{"x":141,"y":288,"id":71,"img":"clothes_071_tex_0.png","color":"c_skin"},{"x":118,"y":287,"id":71,"img":"clothes_071_tex_1.png"}],{"x":27,"y":266,"id":72,"img":"clothes_072.png"},[{"x":143,"y":301,"id":73,"img":"clothes_073_tex_0.png","color":"c_skin"},{"x":121,"y":298,"id":73,"img":"clothes_073_tex_1.png"}],{"x":41,"y":271,"id":74,"img":"clothes_074.png"},{"x":48,"y":277,"id":75,"img":"clothes_075.png"},{"x":47,"y":273,"id":76,"img":"clothes_076.png"},{"x":42,"y":275,"id":77,"img":"clothes_077.png"},[{"x":131,"y":376,"id":901,"img":"clothes_901_tex_0.png","color":"c_skin"},{"x":79,"y":8,"id":901,"img":"clothes_901_tex_1.png"}],[{"x":135,"y":373,"id":902,"img":"clothes_902_tex_0.png","color":"c_skin"},{"x":128,"y":291,"id":902,"img":"clothes_902_tex_1.png"}],[{"x":144,"y":385,"id":903,"img":"clothes_903_tex_0.png","color":"c_skin"},{"x":129,"y":302,"id":903,"img":"clothes_903_tex_1.png"}],[{"x":136,"y":386,"id":904,"img":"clothes_904_tex_0.png","color":"c_skin"},{"x":126,"y":291,"id":904,"img":"clothes_904_tex_1.png"}],[{"x":141,"y":375,"id":905,"img":"clothes_905_tex_0.png","color":"c_skin"},{"x":130,"y":287,"id":905,"img":"clothes_905_tex_1.png"}],[{"x":133,"y":379,"id":906,"img":"clothes_906_tex_0.png","color":"c_skin"},{"x":132,"y":289,"id":906,"img":"clothes_906_tex_1.png"}],[{"x":127,"y":382,"id":907,"img":"clothes_907_tex_0.png","color":"c_skin"},{"x":135,"y":286,"id":907,"img":"clothes_907_tex_1.png"}],[{"x":208,"y":377,"id":908,"img":"clothes_908_tex_0.png","color":"c_skin"},{"x":42,"y":281,"id":908,"img":"clothes_908_tex_1.png"}],[{"x":209,"y":378,"id":909,"img":"clothes_909_tex_0.png","color":"c_skin"},{"x":37,"y":282,"id":909,"img":"clothes_909_tex_1.png"}],[{"x":210,"y":388,"id":910,"img":"clothes_910_tex_0.png","color":"c_skin"},{"x":39,"y":27,"id":910,"img":"clothes_910_tex_1.png"}],[{"x":206,"y":385,"id":911,"img":"clothes_911_tex_0.png","color":"c_skin"},{"x":41,"y":42,"id":911,"img":"clothes_911_tex_1.png"}],[{"x":74,"y":440,"id":912,"img":"clothes_912_tex_0.png","color":"c_skin"},{"x":56,"y":298,"id":912,"img":"clothes_912_tex_1.png"}],{"x":122,"y":302,"id":913,"img":"clothes_913.png"},[{"x":130,"y":371,"id":914,"img":"clothes_914_tex_0.png","color":"c_skin"},{"x":113,"y":405,"id":914,"img":"clothes_914_tex_1.png"}],[{"x":130,"y":370,"id":915,"img":"clothes_915_tex_0.png","color":"c_skin"},{"x":115,"y":410,"id":915,"img":"clothes_915_tex_1.png"}],[{"x":130,"y":370,"id":916,"img":"clothes_916_tex_0.png","color":"c_skin"},{"x":113,"y":406,"id":916,"img":"clothes_916_tex_1.png"}],{"x":30,"y":272,"id":917,"img":"clothes_917.png"},{"x":41,"y":290,"id":918,"img":"clothes_918.png"},{"x":123,"y":299,"id":919,"img":"clothes_919.png"},[{"x":133,"y":390,"id":920,"img":"clothes_920_tex_0.png","color":"c_skin"},{"x":111,"y":294,"id":920,"img":"clothes_920_tex_1.png"}],{"x":122,"y":276,"id":921,"img":"clothes_921.png"},{"x":58,"y":-40,"id":922,"img":"clothes_922.png"},{"x":59,"y":-45,"id":923,"img":"clothes_923.png"},[{"x":76,"y":458,"id":924,"img":"clothes_924_tex_0.png","color":"c_skin"},{"x":48,"y":280,"id":924,"img":"clothes_924_tex_1.png"}],{"x":122,"y":300,"id":925,"img":"clothes_925.png"},{"x":123,"y":299,"id":926,"img":"clothes_926.png"},{"x":63,"y":301,"id":927,"img":"clothes_927.png"},{"x":63,"y":301,"id":928,"img":"clothes_928.png"},{"x":63,"y":301,"id":929,"img":"clothes_929.png"},{"x":63,"y":301,"id":930,"img":"clothes_930.png"}]},
colors = {"c_skin":[{"color":[1,1,1],"id":1},{"color":[1.0408163265306123,1.1225490196078431,1.1666666666666667],"id":2},{"color":[0.9061224489795918,0.8529411764705882,0.8111111111111111],"id":3},{"color":[0.6857142857142857,0.6421568627450981,0.6444444444444445],"id":4},{"color":[0.4775510204081633,0.4411764705882353,0.4166666666666667],"id":5},{"color":[0.5306122448979592,0.7058823529411765,0.9833333333333333],"id":6},{"color":[1.0285714285714285,1.0196078431372548,1.0555555555555556],"id":7},{"color":[1.0408163265306123,1.1274509803921569,1.2277777777777779],"id":8},{"color":[0.889795918367347,0.8186274509803921,0.85],"id":9},{"color":[1.0408163265306123,1.1274509803921569,1.0555555555555556],"id":10},{"color":[1.0408163265306123,1.0392156862745099,0.9444444444444444],"id":11},{"color":[0.673469387755102,0.6078431372549019,0.5555555555555556],"id":12}],"c_hair":[{"color":[1.4370370370370371,1.2352941176470589,1.1195652173913044],"id":1},{"color":[1.8814814814814815,2.1176470588235294,1.4673913043478262],"id":2},{"color":[1.4,1.7254901960784315,1.8369565217391304],"id":3},{"color":[1.488888888888889,1.6764705882352942,1.684782608695652],"id":4},{"color":[1.451851851851852,1.4705882352941178,0.9347826086956522],"id":5},{"color":[1.8888888888888888,1.5784313725490196,1.6630434782608696],"id":6},{"color":[1.0222222222222221,0.9117647058823529,1.358695652173913],"id":7},{"color":[1.8888888888888888,2.284313725490196,2.217391304347826],"id":8},{"color":[1,1,1],"id":9},{"color":[1.4592592592592593,1.3235294117647058,0.9565217391304348],"id":10},{"color":[1.1777777777777778,1.2843137254901962,1.2608695652173914],"id":11},{"color":[1.3111111111111111,1.3235294117647058,1.2065217391304348],"id":12},{"color":[1,1.1470588235294117,1],"id":13},{"color":[1.1185185185185185,2.1372549019607843,2.5869565217391304],"id":14},{"color":[1.8888888888888888,2.0588235294117645,1.5978260869565217],"id":15},{"color":[1.7703703703703704,2.303921568627451,2.5217391304347827],"id":16},{"color":[0.5925925925925926,0.6078431372549019,0.6195652173913043],"id":17},{"color":[1.1555555555555554,0.9411764705882353,0.7608695652173914],"id":18},{"color":[0.45185185185185184,0.5490196078431373,0.5217391304347826],"id":19},{"color":[0.7037037037037037,0.6274509803921569,0.5652173913043478],"id":20},{"color":[0.5037037037037037,0.5,0.5869565217391305],"id":21},{"color":[0.7333333333333333,1.6470588235294117,1.7826086956521738],"id":22},{"color":[1.1777777777777778,2.127450980392157,1.6195652173913044],"id":23},{"color":[1.8888888888888888,2.0098039215686274,2.1847826086956523],"id":24}],"c_eye":[{"color":[1,1,1],"id":1},{"color":[1.1042944785276074,2.5,1.868421052631579],"id":2},{"color":[0.26993865030674846,2.6,3.3947368421052633],"id":3},{"color":[0.8466257668711656,1.3,1.5],"id":4},{"color":[0.9447852760736196,1.8666666666666667,2.973684210526316],"id":5},{"color":[0.2822085889570552,2.4166666666666665,4.657894736842105],"id":6},{"color":[0.901840490797546,1.55,2.3157894736842106],"id":7},{"color":[1.116564417177914,1.55,0.2631578947368421],"id":8},{"color":[0.3619631901840491,1.3166666666666667,4.052631578947368],"id":9},{"color":[0.6993865030674846,1.3333333333333333,1.9210526315789473],"id":10},{"color":[1.1717791411042944,0.8833333333333333,1.4736842105263157],"id":11},{"color":[1.030674846625767,1.35,2.4210526315789473],"id":12}],"c_clothes":[{"color":[1,1,1],"id":1},{"color":[1,1.2116402116402116,1.0842696629213484],"id":2},{"color":[0.8392156862745098,1.291005291005291,1.1573033707865168],"id":3},{"color":[0.9137254901960784,1.1058201058201058,1.297752808988764],"id":4},{"color":[0.9686274509803922,1.2433862433862435,1.2865168539325842],"id":5},{"color":[0.7647058823529411,0.9576719576719577,1.0056179775280898],"id":6}]},
sprite_names = Object.keys(sprites_info),
color_names = Object.keys(colors),
sprite_cnvs = {},
sprites = {},
positions = {},		// current kanojo sprite/colors position
selected = 'face';	// selected item to change


function clearCanvas(cnvs, ctx) {
	if (ctx === undefined) {
		ctx = cnvs.getContext("2d");
	}
	// maybe use only: ctx.clearRect(0, 0, cnvs.width, cnvs.height);

	// Store the current transformation matrix
	ctx.save();
	
	// Use the identity matrix while clearing the canvas
	ctx.setTransform(1, 0, 0, 1, 0, 0);
	ctx.clearRect(0, 0, cnvs.width, cnvs.height);
	
	// Restore the transform
	ctx.restore();
}

function loadImage(url, canvas, info, onload) {
	var c = canvas;
	var img = new Image();
	img.src = url;
	img.onload = function (e) {
		if (c === undefined) {
			c = document.createElement("canvas");
		}
		c.width = img.width;
		c.height = img.height;
		var ctx = c.getContext("2d");
		clearCanvas(c, ctx);
		ctx.drawImage(img, 0, 0);
		//pixels = ctx.getImageData(0, 0, img.width, img.height);
		onload(c, info);
	}
}

function change_type(obj) {
	selected = obj.value;
}

function change_color(pixels, new_color_arr) {
	for(var I = 0, L = pixels.data.length; I < L; I += 4) {
		if(pixels.data[I + 3] > 0) {
			pixels.data[I] = pixels.data[I] * new_color_arr[0];
			pixels.data[I + 1] = pixels.data[I + 1] * new_color_arr[1];
			pixels.data[I + 2] = pixels.data[I + 2] * new_color_arr[2];
		}
	}
	return pixels;
}

function onload_image(cnvs, info) {
	var pos = positions[info.key];
	if (pos == info.pos) {
		var colored = undefined,
			clear_canvas = sprites[info.key].length == 0,
			img_info = sprites_info[info.key][pos];
		if (img_info instanceof Array && info.i !== undefined) {
			img_info = img_info[info.i];
		}

		var pixels = cnvs.getContext('2d').getImageData(0, 0, cnvs.width, cnvs.height),
			refresh_piece = false,
			pos;
		if (info.i !== undefined) {
			pos = info.i;
			sprites[info.key][pos] = pixels;
			if (pos != (sprites[info.key].length-1)) {
				refresh_piece = true;
			}
		} else {
			pos = sprites[info.key].length;
			sprites[info.key].push(pixels);
		}

		var destCtx = sprite_cnvs[info.key].getContext('2d'),
			color_name, colored;
		
		if (refresh_piece) {
			clearCanvas(sprite_cnvs[info.key], destCtx);
			for (var i=0, L=sprites[info.key].length; i<L; i++) {
				if (sprites[info.key][i] !== undefined) {
					colored = undefined;
					img_info = sprites_info[info.key][info.pos][i];
					color_name = img_info.color;
					pixels = sprites[info.key][i];
					if (color_name !== undefined) {
						colored = __colorize_sprite(pixels, colors[color_name][positions[color_name]].color);
					}
					if (colored !== undefined) {
						drawImageData(destCtx, colored, img_info.x, img_info.y);
					} else {
						drawImageData(destCtx, pixels, img_info.x, img_info.y);
					}
				}
			}
		} else {
			color_name = img_info.color;
			if (color_name !== undefined) {
				colored = __colorize_sprite(pixels, colors[color_name][positions[color_name]].color);
			}
			if (clear_canvas) {
				clearCanvas(sprite_cnvs[info.key], destCtx);
			}
			if (colored !== undefined) {
				drawImageData(destCtx, colored, img_info.x, img_info.y);
			} else {
				drawImageData(destCtx, pixels, img_info.x, img_info.y);
			}
		}
	}
}

function __colorize_sprite(pixels, color) {
	if (color === undefined) {
		return pixels;
	}

	var colored = canvas.getContext('2d').createImageData(pixels.width, pixels.height);
	colored.data.set(pixels.data);

	colored = change_color(colored, color);

	return colored;
}

function __draw_colored_sprite(ctx, piece_info, sprite_key, color_key, j, color) {
	var pixels = sprites[sprite_key][j],
		color_key = piece_info.color;

	if (pixels) {
		if (color_key) {
			pixels = __colorize_sprite(pixels, colors[color_key][positions[color_key]].color);
		}
		drawImageData(ctx, pixels, piece_info.x, piece_info.y);
	}
}

function drawImageData(destCtx, imageData, x, y) {
	//destCtx.putImageData(imageData, x, y);
	canvas.width = imageData.width;
	canvas.height = imageData.height;
	clearCanvas(canvas);
	canvas.getContext('2d').putImageData(imageData, 0, 0);
	destCtx.drawImage(canvas, x, y);
}

function set_position(key, pos) {
	//console.log(key, pos);
	positions[key] = pos;
	if (sprite_names.indexOf(key) > -1) {
		var info,
			has_imgs = false,
			piece = sprites_info[key][pos];
		sprites[key] = [];
		//console.log(piece);
		if (piece instanceof Array) {
			console.log(key, piece[0].id);
			for (var i=0; i<piece.length; i++) {
				has_imgs |= piece[i].img !== undefined;
				info = { 'key': key, 'pos': pos, 'i': i };
				loadImage(piece[i].img, canvas, info, onload_image);
			}
		} else if (piece.img) {
			console.log(key, piece.id);
			has_imgs = true;
			info = { 'key': key, 'pos': pos };
			loadImage(piece.img, canvas, info, onload_image);
		}
		if (!has_imgs) {
			clearCanvas(sprite_cnvs[key]);
		}
	} else if (color_names.indexOf(key) > -1) {
		console.log(key, pos);
		// change sprites color
		var sprite_pos, pixels, colored, destCtx, piece_info,
			color = colors[key][pos].color;

		for (var i=0, j; i<sprite_names.length; i++) {
			sprite_key = sprite_names[i];
			sprite_pos = positions[sprite_key];

			destCtx = sprite_cnvs[sprite_key].getContext('2d');
			clearCanvas(sprite_cnvs[sprite_key], destCtx);
			if (sprites_info[sprite_key][sprite_pos] instanceof Array) {
				for (j=0; j<sprites_info[sprite_key][sprite_pos].length; j++) {
					piece_info = sprites_info[sprite_key][sprite_pos][j];
					__draw_colored_sprite(destCtx, piece_info, sprite_key, key, j, color);
				}
			} else {
				piece_info = sprites_info[sprite_key][sprite_pos];
				__draw_colored_sprite(destCtx, piece_info, sprite_key, key, 0, color);
			}
		}
	}
}

function change_value(val) {
	var pos = positions[selected] + val,
		all_values;
	if (sprite_names.indexOf(selected) > -1) {
		all_values = sprites_info[selected];
	} else if (color_names.indexOf(selected) > -1) {
		all_values = colors[selected]
	} else {
		console.log('Error "selected" value.');
		return ;
	}
	if (pos < 0) {
		pos = all_values.length - 1;
	} else if (pos >= all_values.length) {
		pos = 0;
	}

	set_position(selected, pos);
}

function AJAX_JSON(params) {
	var xhr = new XMLHttpRequest()
		url = params.url;
	xhr.onreadystatechange = function() {
		if(xhr.readyState != 4) return;
		if (params.callback !== undefined) {
			params.callback(xhr.responseText, xhr.status, params.user_data);
		}
	}

	xhr.open('POST', url, true);
	xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
	xhr.send(JSON.stringify(params.data));
}

function search() {
	var data = {},
		search_label = document.getElementById('search_result');
	search_label.innerHTML = 'Searching...';
	for (var i=0, key; i<color_names.length; i++) {
		key = color_names[i];
		data[key] = colors[key][positions[key]].id;
	}
	for (var i=0, key; i<sprite_names.length; i++) {
		key = sprite_names[i];
		data[key] = sprites_info[key][positions[key]];
		if (data[key] instanceof Array) {
			data[key] = data[key][0].id;
		} else {
			data[key] = data[key].id;
		}
	}
	console.log(JSON.stringify(data));
	AJAX_JSON({
		url: '/search_barcode.json',
		data: data,
		callback: function(data, status, user_data) {
			if (status==200) {
				var r = JSON.parse(data);
				if (r.code == 200) {
					search_label.innerHTML = r.barcode;
				} else {
					search_label.innerHTML = 'Not found';
				}
			}
		}
	});
}

function generate() {
	var data = {},
		barcode_result = document.getElementById('barcode_result');
	barcode_result.innerHTML = 'Server do their best now and are preparing. Please wait warmly until it is ready.';
	for (var i=0, key; i<color_names.length; i++) {
		key = color_names[i];
		data[key] = colors[key][positions[key]].id;
	}
	for (var i=0, key; i<sprite_names.length; i++) {
		key = sprite_names[i];
		data[key] = sprites_info[key][positions[key]];
		if (data[key] instanceof Array) {
			data[key] = data[key][0].id;
		} else {
			data[key] = data[key].id;
		}
	}
	console.log(JSON.stringify(data));
	AJAX_JSON({
		url: '/generate_barcode.json',
		data: data,
		callback: function(data, status, user_data) {
			if (status==200) {
				var r = JSON.parse(data);
				if (r.code == 200) {
					barcode_result.innerHTML = r.barcode;
				} else {
					barcode_result.innerHTML = 'Something wrong.';
				}
			} else {
				barcode_result.innerHTML = 'Something wrong.';
			}
		}
	});
}

window.onload = function(e) {
	console.log(sprite_names);
	// https://www.barcodekanojo.com/kanojo/355156/_
	positions = { 'c_hair': 4, 'c_clothes': 4, 'c_eye': 1, 'c_skin': 2,     "ear": 0,  "mouth": 0, "spot": 2,  "brow": 1,  "face": 3,  "accessory": 4,  "clothes": 57,  "nose": 1,  "eye": 7,   "glasses": 0,  "hair": 9,  "body": 0,   "fringe": 0 };
	//positions = { 'c_hair': 16, 'c_clothes': 0, 'c_eye': 6, 'c_skin': 0, "ear": 1, "mouth": 2, "spot": 0, "brow": 6, "face": 2, "accessory": 0, "clothes": 2, "nose": 5, "eye": 5, "glasses": 0, "hair": 23+1, "body": 0, "fringe": 15 };

	//positions['clothes'] = sprites_info['clothes'].length-1;
	positions['clothes'] = 100;

	for (var i=0, key, pos; i<sprite_names.length; i++) {
		key = sprite_names[i];
		sprite_cnvs[key] = document.getElementById('bk_'+key);
		set_position(key, positions[key]);
	}
}
//]]>
    </script>

    <style type="text/css">
#kanojo {
  width: 420px;
  height: 593px;
/*  background-color: gray;*/
}
#kanojo canvas {
  position: absolute;
}
#search_result {
  padding-left: 20px;
}
#barcode_result {
  padding-left: 20px;
}
    </style>
</head>
<body>
	<div id="kanojo">
		<canvas id="bk_hair" width="420px" height="593px"></canvas>
		<canvas id="bk_body" width="420px" height="593px"></canvas>
		<canvas id="bk_ear" width="420px" height="593px"></canvas>
		<canvas id="bk_face" width="420px" height="593px"></canvas>
		<canvas id="bk_mouth" width="420px" height="593px"></canvas>
		<canvas id="bk_eye" width="420px" height="593px"></canvas>
		<canvas id="bk_nose" width="420px" height="593px"></canvas>
		<canvas id="bk_spot" width="420px" height="593px"></canvas>
		<canvas id="bk_glasses" width="420px" height="593px"></canvas>
		<canvas id="bk_fringe" width="420px" height="593px"></canvas>
		<canvas id="bk_brow" width="420px" height="593px"></canvas>
		<canvas id="bk_accessory" width="420px" height="593px"></canvas>
		<canvas id="bk_clothes" width="420px" height="593px"></canvas>
	</div>
	<br>
	<input type="button" value="<" onclick="change_value(-1)">
	<select name="type" id="type" onchange="change_type(this)">
		<optgroup label="--Person--"></optgroup>
		<option value="face">Face</option>
		<option value="hair">Hair</option>
		<option value="fringe">Fringe</option>
		<option value="eye">Eye</option>
		<option value="brow">Brow</option>
		<option value="ear">Ear</option>
		<option value="mouth">Mouth</option>
		<option value="nose">Nose</option>
		<option value="glasses">Glasses</option>
		<option value="clothes">Clothes</option>
		<option value="spot">Spot</option>
		<option value="accessory">Accessory</option>
		<optgroup label="--Color--"></optgroup>
		<option value="c_hair">Hair</option>
		<option value="c_skin">Skin</option>
		<option value="c_eye">Eye</option>
		<option value="c_clothes">Clothes</option>
	</select>
	<input type="button" value=">" onclick="change_value(1)">
	<br>
	<input type="button" value="Search barcode" onclick="search()"><label id="search_result"></label>
	<br>
	<input type="button" value="Generate barcode" onclick="generate()"><label id="barcode_result"></label>
	
</body>
</html>